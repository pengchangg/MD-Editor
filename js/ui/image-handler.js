const ImageHandler=function(){const e=document.getElementById("image-btn"),t=document.getElementById("image-upload-modal"),o=document.getElementById("image-file"),n=document.getElementById("upload-image-btn"),r=document.getElementById("image-preview"),i=document.getElementById("editor"),a=t.querySelector(".close"),c={},s=4194304;function l(){ModalModule.openModal(t),o.value="",r.innerHTML=""}function g(){ModalModule.closeModal(t)}function d(e){const t=e.target.files[0];if(!t)return;if(!t.type.match("image.*"))return void UIUtils.showNotification("请选择图片文件","error");if(t.size>5242880)return UIUtils.showNotification("图片过大，请选择小于5MB的图片","error"),o.value="",void(r.innerHTML="");const n=new FileReader;n.onload=function(e){r.innerHTML=`<img src="${e.target.result}" alt="预览图片">`},n.readAsDataURL(t)}function u(e,t=1200,o=.7){return new Promise(((n,r)=>{try{if(!e||"string"!=typeof e)return console.error("compressImage: 输入的dataUrl不是字符串:",typeof e),void r(new Error("无效的图片数据"));const i=new Image;i.onload=function(){try{if(i.width<=t)return void n(e);const a=document.createElement("canvas"),c=a.getContext("2d"),s=t/i.width;a.width=t,a.height=i.height*s,c.drawImage(i,0,0,a.width,a.height);const l=a.toDataURL("image/jpeg",o);if(!l||"string"!=typeof l)return console.error("压缩后的图片数据不是字符串:",typeof l),void r(new Error("压缩图片失败"));n(l)}catch(e){console.error("压缩图片时出错:",e),r(e)}},i.onerror=function(e){console.error("加载图片时出错:",e),r(e)},i.src=e}catch(e){console.error("compressImage函数执行出错:",e),r(e)}}))}function f(e){return function(){let e=0;for(const t in c)e+=c[t].data.length;for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);"md_editor_images"!==o&&(e+=(localStorage.getItem(o)||"").length)}return e}()+e<s}function m(){const e=o.files[0];if(!e)return void UIUtils.showNotification("请先选择图片","error");if(e.size>5242880)return void UIUtils.showNotification("图片过大，请选择小于5MB的图片","error");UIUtils.showNotification("正在处理图片，请稍候...","info");const t=new FileReader;t.onload=async function(t){try{let o=await u(t.target.result);if(!o||"string"!=typeof o)return console.error("压缩后的图片数据不是字符串:",typeof o),void UIUtils.showNotification("图片处理失败: 无效的图片数据","error");if(!f(o.length)){if(!(function(e){const t=Object.entries(c).sort(((e,t)=>new Date(e[1].date)-new Date(t[1].date)));let o=0,n=0;for(const[r,a]of t)if(!i.value.includes(r)&&(o+=a.data.length,delete c[r],n++,o>=e))break;return n>0&&(UIUtils.showNotification(`已自动清理 ${n} 张未使用的旧图片以释放空间`,"info"),!0)}(o.length)&&f(o.length)||(o=await u(o,800,.5),f(o.length))))return void UIUtils.showNotification("存储空间不足，无法保存图片。请删除一些内容后重试。","error")}const n="img_"+Date.now();console.debug("生成的图片ID:",n),c[n]={name:e.name,type:"image/jpeg",size:o.length,data:o,date:(new Date).toISOString()};try{h()}catch(e){return UIUtils.showNotification("保存图片失败: "+e.message,"error"),void delete c[n]}const r=i.selectionStart,a=i.value.substring(0,r),s=i.value.substring(r),l=`![${e.name.replace(/\.[^/.]+$/,"")}](${n})\n`;console.debug("插入的Markdown:",l),i.value=a+l+s,i.selectionStart=i.selectionEnd=r+l.length;const d=new Event("input");if(i.dispatchEvent(d),g(),UIUtils.showNotification(`图片 "${e.name}" 已插入`,"success"),w(),"undefined"!=typeof StorageUtils&&"function"==typeof StorageUtils.saveContent){console.debug("图片插入后自动保存文章"),StorageUtils.saveContent(i.value);const e=document.getElementById("save-status");e&&(e.textContent="已保存")}}catch(e){console.error("处理图片时出错:",e),UIUtils.showNotification("处理图片失败: "+e.message,"error")}},t.readAsDataURL(e)}function h(){try{const e=JSON.stringify(c);localStorage.setItem("md_editor_images",e)}catch(e){throw console.error("保存图片到localStorage失败:",e),e}}function w(){let e=0;for(const t in c)e+=c[t].data.length;const t=(e/1024).toFixed(2),o=(t/1024).toFixed(2);let n="";n=o>=1?`${o} MB`:`${t} KB`;const r=(e/s*100).toFixed(1),i=document.getElementById("storage-size");i.textContent=`${n} (${r}%)`,i.style.color=r>80?"var(--warning-color)":""}function p(e,t=!1){const o=[],n=/!\[.*?\]\((img_[0-9]+)\)/g;let r;for(;null!==(r=n.exec(e));)o.push(r[1]);let i=0,a=0;for(const e in c)o.includes(e)||(a+=c[e].data.length,delete c[e],i++);if(i>0)try{h(),w();const e=(a/1024).toFixed(2),o=(e/1024).toFixed(2);let n="";n=o>=1?`${o} MB`:`${e} KB`;const r=t?"notification-manual-cleanup-success":"notification-auto-cleanup-success";let c=r;"undefined"!=typeof LanguageModule&&LanguageModule.getTranslation?(c=LanguageModule.getTranslation(r),c=c.replace("{0}",i).replace("{1}",n)):c=t?`已手动清理 ${i} 张未使用的图片，释放了 ${n} 空间`:`已清理 ${i} 张未使用的图片，释放了 ${n} 空间`,UIUtils.showNotification(c,"info")}catch(e){console.error("保存清理后的图片数据失败:",e),UIUtils.showNotification("清理图片后保存失败: "+e.message,"error")}return{cleaned:i,freedSpace:a}}function y(){const e=i.value,t=[],o=/!\[.*?\]\((img_[0-9]+)\)/g;let n;for(;null!==(n=o.exec(e));)t.push(n[1]);let r=0;for(const e of t)c[e]||(console.warn(`图片 ${e} 不存在于localStorage中`),r++);r>0&&console.warn(`发现 ${r} 张图片缺失`)}return{init:function(){!function(){try{console.debug("开始从localStorage加载图片数据");const e=localStorage.getItem("md_editor_images");if(!e)return void console.debug("localStorage中没有保存的图片数据");console.debug("从localStorage加载的原始数据长度:",e.length);try{const t=JSON.parse(e);if("object"!=typeof t)return console.error("加载的图片数据不是对象:",typeof t),void UIUtils.showNotification("加载图片数据失败，格式无效","error");console.debug("解析后的图片数据包含",Object.keys(t).length,"张图片");for(const e in t){const o=t[e];o&&"object"==typeof o?o.data&&"string"==typeof o.data&&o.data.startsWith("data:")?(o.name=o.name||"unknown.jpg",o.type=o.type||"image/jpeg",o.size=o.size||o.data.length,o.date=o.date||(new Date).toISOString(),c[e]=o,console.debug(`成功加载图片 ${e}, 名称: ${o.name}, 大小: ${o.size} 字节`)):console.warn(`图片 ${e} 的数据无效，跳过`,o.data?"数据类型: "+typeof o.data:"数据为空",o.data&&"string"==typeof o.data?`数据前缀: ${o.data.substring(0,20)}...`:""):console.warn(`图片 ${e} 数据无效，跳过`)}console.log(`成功加载 ${Object.keys(c).length} 张图片`),Object.keys(c).length>0&&w()}catch(e){console.error("解析图片数据JSON失败:",e),UIUtils.showNotification("加载图片数据失败，JSON解析错误","error")}}catch(e){console.error("从localStorage加载图片失败:",e),UIUtils.showNotification("加载图片数据失败，可能是数据损坏","error")}}(),e.addEventListener("click",l),a.addEventListener("click",g),o.addEventListener("change",d),n.addEventListener("click",m);const t=document.getElementById("cleanup-images-btn");t&&t.addEventListener("click",(()=>{!function(){const e=i.value;p(e,!0).cleaned||UIUtils.showNotification("notification-no-images-to-cleanup","info")}()})),y()},processImages:function(e){try{if(!e||"string"!=typeof e){if(console.warn("processImages: 输入的HTML不是字符串:",typeof e),null===e)return"";if(void 0===e)return"";if("object"!=typeof e)return String(e||"");try{return String(e)}catch(e){return console.error("无法将对象转换为字符串:",e),""}}console.debug("处理HTML中的图片，HTML长度:",e.length);const t=Object.keys(c);if(0===t.length)return console.debug("没有本地图片数据，跳过处理"),e;console.debug("本地图片数量:",t.length);let o=!1;for(const n of t)e.includes(`data-img-id="${n}"`)&&(o=!0,console.debug(`找到本地图片ID: ${n}`));if(!o)return console.debug("HTML中没有找到本地图片ID，跳过处理"),e;return e.replace(/<img[^>]*data-img-id="(img_[0-9]+)"[^>]*>/g,((e,t)=>{try{if(console.debug("处理图片标签，ID:",t),t=String(t),c[t]){const o=e.match(/alt=["']([^"']*)["']/),n=e.match(/title=["']([^"']*)["']/),r=o?String(o[1]):"",i=n?` title="${String(n[1])}"`:"",a=' class="local-image"',s=String(c[t].data||"");return s?(console.debug(`成功替换图片 ${t}`),`<img src="${s}" alt="${r}"${i}${a}>`):(console.warn(`图片 ${t} 的数据为空`),"<img src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect fill='%23f0f0f0' width='100' height='100'/%3E%3Cpath fill='%23d9534f' d='M30 30 L70 70 M70 30 L30 70'/%3E%3C/svg%3E\" alt=\"图片数据为空\" class=\"local-image error\">")}return console.warn(`找不到图片数据，ID: ${t}`),"<img src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect fill='%23f0f0f0' width='100' height='100'/%3E%3Cpath fill='%23d9534f' d='M30 30 L70 70 M70 30 L30 70'/%3E%3C/svg%3E\" alt=\"图片加载失败\" class=\"local-image error\">"}catch(o){return console.error("处理图片时出错:",o,t),e}}))}catch(t){return console.error("processImages函数执行出错:",t),String(e||"")}},updateStorageInfo:w,cleanupUnusedImages:p,validateImages:y}}();document.addEventListener("DOMContentLoaded",(function(){ImageHandler.init()}));