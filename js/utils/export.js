const ExportModule={currentExportType:null,currentFileName:null,isMenuToggling:!1,lastClickTime:0,isExporting:!1,isShowingPreview:!1,debugMode:!0,init:function(){console.log("导出模块初始化"),this.bindEvents(),this.updateDebugInfo(),this.isMenuToggling=!1,this.lastClickTime=0,this.isExporting=!1,this.isShowingPreview=!1,this.debugMode=!0},updateDebugInfo:function(){const e=document.getElementById("export-module-status");e&&(e.textContent="已加载",e.style.color="#2ecc71");const o=document.getElementById("html2pdf-status");o&&("function"==typeof html2pdf?(o.textContent="已加载",o.style.color="#2ecc71"):(o.textContent="未加载",o.style.color="#e74c3c"))},bindEvents:function(){console.log("绑定导出按钮事件");const e=document.getElementById("export-btn"),o=document.getElementById("export-md-btn"),t=document.getElementById("export-pdf-btn"),n=document.getElementById("export-preview-modal"),i=document.getElementById("confirm-export-btn"),r=document.getElementById("cancel-export-btn"),s=n.querySelector(".close"),d=document.getElementById("export-filename");document.getElementById("export-extension");e&&o&&t?(e.addEventListener("click",(function(e){e.stopPropagation(),e.preventDefault();const o=Date.now();if(o-ExportModule.lastClickTime<300)return void console.log("忽略重复点击");ExportModule.lastClickTime=o,console.log("点击导出按钮");const t=document.querySelector(".dropdown-content");if(!t)return void console.error("找不到下拉菜单");ExportModule.isMenuToggling=!0;t.classList.contains("show")?(t.classList.remove("show"),console.log("下拉菜单显示状态: false")):(t.classList.add("show"),console.log("下拉菜单显示状态: true")),setTimeout((()=>{ExportModule.isMenuToggling=!1}),300)})),o.addEventListener("click",(function(e){console.log("点击Markdown导出按钮"),e.stopPropagation(),e.preventDefault();const o=document.querySelector(".dropdown-content");o&&(o.classList.remove("show"),console.log("下拉菜单显示状态: false")),setTimeout((()=>{ExportModule.showExportPreview("markdown")}),50)})),t.addEventListener("click",(function(e){console.log("点击PDF导出按钮"),e.stopPropagation(),e.preventDefault();const o=document.querySelector(".dropdown-content");o&&(o.classList.remove("show"),console.log("下拉菜单显示状态: false")),setTimeout((()=>{ExportModule.showExportPreview("pdf")}),50)})),i.addEventListener("click",(function(e){e.stopPropagation(),e.preventDefault();const o=Date.now();if(o-ExportModule.lastClickTime<500)return void console.log("忽略重复点击确认导出按钮");ExportModule.lastClickTime=o;const t=d.value.trim();if(!t)return alert("请输入文件名"),void d.focus();"markdown"===ExportModule.currentExportType?ExportModule.exportMarkdown(t):"pdf"===ExportModule.currentExportType&&ExportModule.exportPDF(t),ModalModule.closeModal(n)})),r.addEventListener("click",(function(){ModalModule.closeModal(n)})),s.addEventListener("click",(function(){ModalModule.closeModal(n)})),document.addEventListener("click",(function(e){if(ExportModule.isMenuToggling)return;if(Date.now()-ExportModule.lastClickTime<300)return;const o=document.querySelector(".dropdown-content");if(!o)return;const t=document.getElementById("export-btn");e.target===t||t.contains(e.target)||o.contains(e.target)||(o.classList.remove("show"),console.log("点击其他区域，关闭下拉菜单"))})),console.log("导出按钮事件绑定完成")):console.error("找不到导出按钮")},showExportPreview:function(e){if(console.log("显示导出预览:",e),this.isShowingPreview)return void console.warn("已有预览正在显示，请稍候...");this.isShowingPreview=!0,this.currentExportType=e;const o=document.getElementById("editor");if(!o)return console.error("找不到编辑器元素"),alert("导出失败：找不到编辑器元素"),void(this.isShowingPreview=!1);const t=o.value;if(!t.trim())return console.warn("编辑器内容为空"),alert("无法导出：编辑器内容为空"),void(this.isShowingPreview=!1);let n="document";const i=t.match(/^#\s+(.+)$/m);i&&i[1]&&(n=i[1].trim().replace(/[^\w\s]/gi,"")),this.currentFileName=n;const r=document.getElementById("export-preview-modal"),s=document.getElementById("export-preview-content"),d=document.getElementById("export-filename"),l=document.getElementById("export-extension");d.value=n,l.textContent="markdown"===e?".md":".pdf";try{if("markdown"===e)s.classList.remove("pdf-preview"),s.innerHTML=`<pre style="white-space: pre-wrap; word-break: break-word;">${this.escapeHtml(t)}</pre>`;else if("pdf"===e){s.classList.add("pdf-preview");const e=document.getElementById("preview");if(!e)return console.error("找不到预览元素"),alert("导出失败：找不到预览元素"),void(this.isShowingPreview=!1);console.log("预览内容HTML长度:",e.innerHTML.length),console.log("预览内容HTML前100个字符:",e.innerHTML.substring(0,100));const o=e.cloneNode(!0),t=document.createElement("style");t.textContent="\n                    /* 移除左侧灰色竖线 */\n                    blockquote {\n                        border-left: none !important;\n                        padding-left: 1em !important;\n                        background-color: rgba(0,0,0,0.03) !important;\n                        border-radius: 4px !important;\n                    }\n                    \n                    /* 改进表格样式 */\n                    table {\n                        width: 100%;\n                        border-collapse: collapse;\n                        margin: 1em 0;\n                    }\n                    \n                    th, td {\n                        border: 1px solid #ddd;\n                        padding: 8px 12px;\n                    }\n                    \n                    th {\n                        background-color: #f5f5f5;\n                    }\n                    \n                    /* 改进代码块样式 */\n                    pre {\n                        background-color: #f6f8fa;\n                        border-radius: 4px;\n                        padding: 16px;\n                        overflow: auto;\n                    }\n                    \n                    code {\n                        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;\n                        font-size: 0.9em;\n                    }\n                    \n                    /* 改进图片样式 */\n                    img {\n                        max-width: 100%;\n                        height: auto;\n                    }\n                ",s.innerHTML="",s.appendChild(t),s.appendChild(o)}ModalModule.openModal(r),r.addEventListener("modalClosed",(()=>{this.isShowingPreview=!1}),{once:!0})}catch(e){console.error("显示导出预览时出错:",e),alert("显示预览失败: "+e.message),this.isShowingPreview=!1}},debugLog:function(e,o){this.debugMode&&(o?console.log(`[导出调试] ${e}`,o):console.log(`[导出调试] ${e}`))},exportMarkdown:function(e){console.log("开始导出Markdown");try{if(this.isExporting)return void console.warn("已有导出任务正在进行中，请稍候...");this.isExporting=!0;const o=document.getElementById("editor");if(!o)return console.error("找不到编辑器元素"),alert("导出失败：找不到编辑器元素"),void(this.isExporting=!1);const t=o.value;if(!t.trim())return console.warn("编辑器内容为空"),alert("无法导出：编辑器内容为空"),void(this.isExporting=!1);const n=new Blob([t],{type:"text/markdown"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=e+".md",document.body.appendChild(r),setTimeout((()=>{r.click(),setTimeout((()=>{document.body.removeChild(r),URL.revokeObjectURL(i),this.isExporting=!1}),100),console.log("Markdown导出成功:",e),UIUtils.showNotification(`已导出为 ${e}.md`,"success")}),100)}catch(e){console.error("导出Markdown时出错:",e),UIUtils.showNotification("导出失败: "+e.message,"error"),this.isExporting=!1}},exportPDF:function(e){this.debugLog("开始导出PDF"),console.log("开始导出PDF");try{if("function"!=typeof html2canvas)return this.debugLog("html2canvas库未加载"),console.error("html2canvas库未加载"),void UIUtils.showNotification("导出失败：html2canvas库未加载","error");if("undefined"==typeof jspdf||"function"!=typeof jspdf.jsPDF)return this.debugLog("jsPDF库未加载或不可用"),console.error("jsPDF库未加载或不可用"),void UIUtils.showNotification("导出失败：jsPDF库未加载或不可用","error");if(this.isExporting)return this.debugLog("已有导出任务正在进行中"),void console.warn("已有导出任务正在进行中，请稍候...");this.isExporting=!0;const o=document.getElementById("preview");if(!o)return this.debugLog("找不到预览元素"),console.error("找不到预览元素"),UIUtils.showNotification("导出失败：找不到预览元素","error"),void(this.isExporting=!1);if(!o.innerHTML.trim())return this.debugLog("预览内容为空"),console.warn("预览内容为空"),UIUtils.showNotification("无法导出PDF：预览内容为空","warning"),void(this.isExporting=!1);this.debugLog("预览内容HTML长度:",o.innerHTML.length),console.log("预览内容HTML长度:",o.innerHTML.length),UIUtils.showNotification("正在生成PDF，请稍候...","info");const t=document.createElement("div");t.id="pdf-export-temp-container",t.style.width="210mm",t.style.padding="20mm",t.style.backgroundColor="#ffffff",t.style.color="#000000",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.zIndex="-9999",t.style.overflow="visible",t.innerHTML=o.innerHTML;const n=document.createElement("style");n.textContent="\n                #pdf-export-temp-container {\n                    font-family: 'LXGW WenKai', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                    line-height: 1.5;\n                }\n                \n                #pdf-export-temp-container h1 { font-size: 2em; margin: 0.67em 0; }\n                #pdf-export-temp-container h2 { font-size: 1.5em; margin: 0.75em 0; }\n                #pdf-export-temp-container h3 { font-size: 1.17em; margin: 0.83em 0; }\n                #pdf-export-temp-container h4 { font-size: 1em; margin: 1.12em 0; }\n                #pdf-export-temp-container h5 { font-size: 0.83em; margin: 1.5em 0; }\n                #pdf-export-temp-container h6 { font-size: 0.75em; margin: 1.67em 0; }\n                \n                #pdf-export-temp-container p { margin: 1em 0; }\n                \n                #pdf-export-temp-container blockquote {\n                    margin: 1em 0;\n                    padding-left: 1em;\n                    border-left: 4px solid #ddd;\n                    color: #666;\n                }\n                \n                #pdf-export-temp-container pre {\n                    background-color: #f6f8fa;\n                    padding: 16px;\n                    overflow: auto;\n                    border-radius: 3px;\n                }\n                \n                #pdf-export-temp-container code {\n                    font-family: monospace;\n                    background-color: rgba(0,0,0,0.05);\n                    padding: 2px 4px;\n                    border-radius: 3px;\n                }\n                \n                #pdf-export-temp-container table {\n                    border-collapse: collapse;\n                    width: 100%;\n                    margin: 1em 0;\n                }\n                \n                #pdf-export-temp-container th, #pdf-export-temp-container td {\n                    border: 1px solid #ddd;\n                    padding: 8px;\n                }\n                \n                #pdf-export-temp-container th {\n                    background-color: #f5f5f5;\n                    font-weight: bold;\n                }\n                \n                #pdf-export-temp-container img {\n                    max-width: 100%;\n                    height: auto;\n                }\n                \n                #pdf-export-temp-container ul, #pdf-export-temp-container ol {\n                    margin: 1em 0;\n                    padding-left: 2em;\n                }\n            ",document.head.appendChild(n),document.body.appendChild(t),this.debugLog("临时容器已添加到文档"),setTimeout((()=>{this.debugLog("开始捕获内容"),html2canvas(t,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!0,onclone:function(e){const o=e.getElementById("pdf-export-temp-container");o&&(o.style.position="static",o.style.zIndex="auto",o.style.visibility="visible",o.style.opacity="1",o.style.display="block")}}).then((o=>{if(this.debugLog("Canvas生成成功，尺寸:",o.width,"x",o.height),o.width<=0||o.height<=0)throw new Error("生成的Canvas无效");const i=new jspdf.jsPDF({orientation:o.width>o.height?"landscape":"portrait",unit:"mm",format:"a4"}),r=i.internal.pageSize.getWidth(),s=i.internal.pageSize.getHeight(),d=r,l=o.height*d/o.width;this.debugLog("PDF尺寸:",r,"x",s),this.debugLog("图像尺寸:",d,"x",l);const c=o.toDataURL("image/jpeg",1);if(!c||c.length<1e3)throw new Error("生成的图像数据无效");this.debugLog("图像数据生成成功，长度:",c.length);let a=l,p=0,m=0;for(i.addImage(c,"JPEG",0,p,d,l),a-=s,m++;a>0;)p=-s*m,i.addPage(),i.addImage(c,"JPEG",0,p,d,l),a-=s,m++;this.debugLog("PDF生成完成，页数:",m),i.save(e+".pdf"),document.body.removeChild(t),document.head.removeChild(n),this.isExporting=!1,this.debugLog("PDF导出成功"),console.log("PDF导出成功:",e),UIUtils.showNotification(`已导出为 ${e}.pdf`,"success")})).catch((o=>{this.debugLog("Canvas生成失败:",o),console.error("Canvas生成失败:",o),this.tryDirectHtml2PDF(t,e,n)}))}),1e3)}catch(e){this.debugLog("导出PDF时出错:",e),console.error("导出PDF时出错:",e),UIUtils.showNotification("导出失败: "+e.message,"error"),this.isExporting=!1}},tryDirectHtml2PDF:function(e,o,t){this.debugLog("尝试使用直接的html2pdf方法");try{e.style.position="static",e.style.zIndex="auto",e.style.visibility="visible",e.style.opacity="1";const n={margin:10,filename:o+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};html2pdf().from(e).set(n).save().then((()=>{this.debugLog("直接html2pdf方法成功"),document.body.contains(e)&&document.body.removeChild(e),document.head.contains(t)&&document.head.removeChild(t),this.isExporting=!1,console.log("PDF导出成功:",o),UIUtils.showNotification(`已导出为 ${o}.pdf`,"success")})).catch((o=>{this.debugLog("直接html2pdf方法失败:",o),console.error("直接html2pdf方法失败:",o),document.body.contains(e)&&document.body.removeChild(e),document.head.contains(t)&&document.head.removeChild(t),this.isExporting=!1,UIUtils.showNotification("PDF导出失败: "+o.message,"error")}))}catch(o){this.debugLog("直接html2pdf方法出错:",o),console.error("直接html2pdf方法出错:",o),document.body.contains(e)&&document.body.removeChild(e),document.head.contains(t)&&document.head.removeChild(t),this.isExporting=!1,UIUtils.showNotification("PDF导出失败: "+o.message,"error")}},escapeHtml:function(e){const o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,(function(e){return o[e]}))}};document.addEventListener("DOMContentLoaded",(function(){ExportModule.init()}));